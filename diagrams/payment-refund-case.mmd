sequenceDiagram
    participant FE as Frontend
    participant BE as Backend
    participant PP as PayPal
    participant DB as Database
    
    Note over FE: User/Staff initiates refund
    
    FE->>+BE: POST /refunds<br/>{transactionId: "txn_456", amount: 100}
    BE->>+DB: Fetch transaction {status: "completed"}
    DB->>-BE: Found
    
    BE->>+PP: POST /v1/oauth2/token
    PP->>-BE: Return access_token
    
    BE->>+PP: POST /v2/payments/captures/{capture_id}/refund
    PP->>-BE: {refund_id, status: "COMPLETED"}
    
    BE->>+DB: Insert refund record {refund_id, status: "completed"}
    DB->>-BE: Refund Inserted
    BE->>+DB: Update transaction {status: "refunded"}
    DB->>-BE: Transaction Updated
    BE->>-FE: {status: "refunded", refundId}
    
    %% Webhook
    PP->>+BE: POST /payments/webhook/paypal<br/>PAYMENT.REFUND.COMPLETED
    BE->>+PP: Verify webhook
    PP->>-BE: Verified
    BE->>+DB: Confirm refund "completed"
    DB->>-BE: Confirmed
    BE->>+DB: Update Booking status {status: "refunded"}
    DB->>-BE: Booking Updated 
    BE->>-PP: 200 OK
    BE->>FE: Push "Refund Completed"
